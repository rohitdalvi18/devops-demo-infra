name: DevSecOps

on:
    workflow_dispatch:

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
  CLUSTER_NAME: devops-demo
  IMAGE_TAG: 1.3.24

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repo
        uses: actions/checkout@v3
        with:
            repository: rohitdalvi18/devops-demo-source
            token: ${{ secrets.GH_TOKEN }}

      - name: Run Security Scans for login-service
        run: |
            # Install Snyk
            npm install -g snyk
            # Scan dependencies
            snyk test
            # Scan container
            snyk container test $ECR_REGISTRY/login-service:${IMAGE_TAG}

      - name: Run Security Scans for order-service
        run: |
            # Install Snyk
            npm install -g snyk
            # Scan dependencies
            snyk test
            # Scan container
            snyk container test $ECR_REGISTRY/order-service:${IMAGE_TAG}

      - name: Run Security Scans for inventory-service
        run: |
            # Install Snyk
            npm install -g snyk
            # Scan dependencies
            snyk test
            # Scan container
            snyk container test $ECR_REGISTRY/inventory-service:${IMAGE_TAG}

      - name: Run Security Scans for payment-service
        run: |
            # Install Snyk
            npm install -g snyk
            # Scan dependencies
            snyk test
            # Scan container
            snyk container test $ECR_REGISTRY/payment-service:${IMAGE_TAG}
